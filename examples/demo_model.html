<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <title>NPZ loader test</title>

    <head>
        <script src="../js/zip/zip.js"></script>
        <script src="../js/zip/zip-ext.js"></script>
        <script src="../js/zip/inflate.js"></script>
        <script src="../js/npy.js"></script>
        <script src="../js/npz.js"></script>
        <script src="../js/arviz.js"></script>
        <script>
        </script>
    </head>

<body>
    <svg></svg>
    <script src="https://d3js.org/d3.v4.min.js"></script>

    <script>
        function drawChart(arviz_data) {

            var observed = arviz_data.observed_data.vars;
            var posterior = arviz_data.posterior.vars;

            function getData(array_data) {
                return array_data.array.data;
            }

            // return a single random sample from the trace
            function getPosteriorSample(vars) {
                var v0 = vars[0];
                var random_index = Math.floor(Math.random() * getData(posterior[v0]).length);
                var samples = {};
                for (i = 0; i < vars.length; i++) {
                    var v = vars[i];
                    samples[v] = getData(posterior[v])[random_index];
                }
                return samples;
            }

            function remap(array, fn) {
                array.array.data = array.array.data.map(fn);
            }

            // remap transformed variables
            remap(posterior.switchpoint, x => x + 1960);
            remap(posterior.poverty_at_switchpoint, x => x + 50);
            remap(observed.year, x => x + 1960);
            remap(observed.y, x => x + 50);


            // select
            var raw_data = {
                "date": getData(observed.year),
                "value": getData(observed.y),
            }

            // transpose 
            var data = [];
            for (var i = 0; i < raw_data.date.length; i++) {
                data.push({
                    "date": raw_data.date[i],
                    "value": raw_data.value[i],
                })
            }
            console.log(data);

            // create canvas
            var svgWidth = 1000,
                svgHeight = 400;
            var margin = {
                top: 20,
                right: 20,
                bottom: 30,
                left: 50
            };
            var width = svgWidth - margin.left - margin.right;
            var height = svgHeight - margin.top - margin.bottom;
            var svg = d3.select('svg')
                .attr("width", svgWidth)
                .attr("height", svgHeight);


            // main group for all elements
            var g = svg.append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")"
                );

            // construct axis objects
            var x = d3.scaleLinear().rangeRound([0, width]);
            var y = d3.scaleLinear().rangeRound([height, 0]);

            // construct the line 
            var line = d3.line()
                .x(function (d) {
                    return x(d.date)
                })
                .y(function (d) {
                    return y(d.value)
                })
            x.domain(d3.extent(data, function (d) {
                return d.date;
            }));
            y.domain([0, 100]);

            // add axis guides
            g.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x))
                .select(".domain")
                .remove();


            g.append("g")
                .call(d3.axisLeft(y))
                .append("text")
                .attr("fill", "#000")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", "0.71em")
                .attr("text-anchor", "end")
                .text("Poverty rate");

            g.append("g")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 1.5)
                .attr("fill", "none")
                .selectAll("circle")
                .data(data)
                .enter()
                .append("circle")
                .attr("cx", d => x(d.date))
                .attr("cy", d => y(d.value))
                .attr("r", 2);


            function setLinePath(sampleData, sigma) {
                d3.selectAll("path").remove();
                g.append("path")
                    .datum(sampleData)
                    .attr("fill", "none")
                    .attr("stroke", "steelblue")
                    .attr("stroke-linejoin", "round")
                    .attr("stroke-linecap", "round")
                    .attr("stroke-width", 2.5)
                    .attr("d", line);

                g.append("path")
                    .datum(sampleData)
                    .attr("fill", "none")
                    .attr("stroke", "steelblue")
                    .attr("stroke-linejoin", "round")
                    .attr("stroke-linecap", "round")
                    .attr('stroke-opacity', 0.2)
                    .attr("stroke-width", 0.5 * y(sigma + 50))
                    .attr("d", line);
            }

            function drawSample() {
                var pSample = getPosteriorSample(["sigma", "left_slope", "right_slope",
                    "switchpoint", "poverty_at_switchpoint"
                ]);

                function map_line(at, slope, from, offset) {
                    return offset + (at - from) * slope;
                }

                // construct the linear segments
                var sample_data = [{
                        date: 1820,
                        value: map_line(1820, pSample.left_slope, pSample.switchpoint, pSample.poverty_at_switchpoint)
                    },
                    {
                        date: pSample.switchpoint,
                        value: map_line(pSample.switchpoint, pSample.left_slope, pSample.switchpoint, pSample.poverty_at_switchpoint)
                    },
                    {
                        date: 2010,
                        value: map_line(2010, pSample.right_slope, pSample.switchpoint, pSample.poverty_at_switchpoint)
                    },
                ];

                setLinePath(sample_data, pSample.sigma);
            }

            // begin animating the draws
            window.setInterval(function () {
                drawSample();
            }, 50);
        }

        load_npz("switchpoint.npz", function (npz_data) {
            drawChart(reassemble_arviz(npz_data));
        });
    </script>


</body>

</body>

</html>