<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Sampler stats</title>
  </head>

  <body class="bg-light">
    <div class="template-holder"></div>

    <script id="entry-template" type="text/x-handlebars-template">
        <div class="container">
        <div class="row">
            <div class="col-md-2"> </div>
                <div class="col-md-8">
                    <h1 class="hero">{{title}}</h1>



            <h2>Inference stats</h2>

            {{!Basic statistics}}
            <table class="table">
                {{#each basic_attribute}}
                <tr> <td> {{@key}} </td> <td> {{this}} </td> </tr>
                {{/each}}
            </table>

            {{! Listing of variables in model}}
            <h2> Model Variables </h2>
            <table class="table">
                <tr>{{#each variable_header}}
                    <th> {{this}} </th>
                    {{/each}}
                </tr>
                {{#each variable_table}}
                <tr>
                    {{#each this}}<td>{{this}}</td>{{/each}}
                </tr>
                {{/each}}
            </table>

            {{#each xarrays}}
            <h2> {{@key}} </h2>
                {{> xarray }}
            {{/each}}


            </div>
            <div class="col-md-2"> </div>
        </div>
        
      </div>
    </script>

    <script src="../js/zip/zip.js"></script>
    <script src="../js/zip/zip-ext.js"></script>
    <script src="../js/zip/inflate.js"></script>
    <script src="../js/npy.js"></script>
    <script src="../js/npz.js"></script>
    <script src="../js/handlebars/handlebars-v4.1.0.js"></script>
    <script src="../js/jstat/jstat.min.js"></script>
    <script src="../js/arviz.js"></script>
    <link rel="stylesheet" type="text/css" href="model_stats.css" />
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>

    <script>
      function showStats(arviz) {
        var sample_attrs = arviz.sample_stats.attrs;

        var kvs = {
          "Inference Library": sample_attrs.inference_library,
          Version: sample_attrs.inference_library_version,
          Date: sample_attrs.created_at
        };

        function createTable(d, fns) {
          var table = [];
          for (k in d) {
            var v = d[k];
            table.push([k].concat(fns.map(fn => fn(v))));
          }
          return table;
        }

        var variable_table = createTable(sample_attrs.graph, [
          d => d.type,
          d => d.parents,
          d => d.distribution.type,
          d => d.distribution.shape
        ]);

        console.log(arviz);

        var source = document.getElementById("entry-template").innerHTML;
        var template = Handlebars.compile(source);

        // print shape of arrays nicely
        Handlebars.registerHelper("shape", function(shape) {
          return "(" + shape.join(", ") + ")";
        });

        // print dtypes in a human readable form
        var dtype_names = {
          "<f8": "float64",
          "<f4": "float32",
          "|b1": "boolean",
          "<i8": "int64",
          "<i2": "int16",
          "<i1": "int8",
          "<i2": "int16",
          "<i4": "int32",
          "<u8": "uint64",
          "<u2": "uint16",
          "<u1": "uint8",
          "<u2": "uint16",
          "<u4": "uint32"
        };

        Handlebars.registerHelper("dtype", function(dtype) {
          return dtype_names[dtype];
        });

        // template for an xarray, showing the dimensions
        Handlebars.registerPartial(
          "xarray",
          `            
            <h4 class="btn btn-primary" data-toggle="collapse" data-target=".{{@key}}_dims"> Dimensions </h4>            
            <table class="table {{@key}}_dims collapse">                
                {{#each dims}}                
                <tr> <td> {{@key}} </td> <td> {{this}} </td> </tr>
                {{/each}}
            </table>            

            <h4 data-toggle="collapse" data-target=".{{@key}}_vars"> Variables </h4>
            <table class="table {{@key}}_vars collapse">
                <tr> <th> Variable </th> <th> Shape </th> <th> dtype </th> </tr>
                {{#each vars}}                
                <tr> <td> {{@key}} </td> <td> {{shape this.shape}} </td> <td> {{dtype this.dtype}} </tr>
                {{/each}}
            </table>
          `
        );

        var html = template({
          title: "Inference results",
          basic_attribute: kvs,
          variable_header: ["Name", "Type", "Parents", "Distribution", "Shape"],

          variable_table: variable_table,
          xarrays: {
            sample_stats: arviz.sample_stats,
            observed: arviz.observed_data,
            posterior: arviz.posterior,
            posterior_predictive: arviz.posterior_predictive,
            prior: arviz.prior
          }
        });

        console.log(html);

        $(".template-holder").append(html);
      }
      /////////////////////////////////////////////////////////////////////////////////////
      // Entry point
      load_npz("switchpoint.npz", function(npz_data) {
        showStats(reassemble_arviz(npz_data));
      });
    </script>
  </body>
</html>
