<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Sampler stats</title>
  </head>

  <body class="bg-light">
    <div class="template-holder"></div>

    <script id="entry-template" type="text/x-handlebars-template">

        {{!-- 
            The template for the web page. Content is dynamically filled in by the 
            script for each section.
        --}}

        <div class="container-fluid">
        <div class="row">
                <div class="jumbotron col-md-12"> <h4> ARViz Inference Data Viewer </h4> </div>
        </div>

        <div class="row">
            {{!Navigation bar on the side panel}}
            <div class="sidebar">
            <nav class="col-md-3 sidebar-nav">
                    
                    <ul class="nav flex-column  ">
                        <li class="nav-item" data-target="basic_stats"> <a class="nav-link active" href='#'>Basic attributes </a></li>
                        <li class="nav-item" data-target="model_variables"> <a class="nav-link" href='#'>Model Variables</a></li>
                        <li class="nav-item" data-target="sampler_statistics"> <a class="nav-link" href='#'>Sampler Statistics </a></li>
                        <li class="nav-item" data-target="observed"> <a class="nav-link" href='#'>Sampler Observations</a></li>
                        <li class="nav-item" data-target="posterior_trace"> <a class="nav-link" href='#'>Posterior Trace </a></li>
                        <li class="nav-item" data-target="posterior_predictive"> <a class="nav-link" href='#'>Posterior Predictive </a></li>
                        <li class="nav-item"data-target="prior"> <a class="nav-link" href='#'>Prior</a></li>
                    </ul>
                    
                </nav>
            </div>


            <div class="col-md-8">

            
            <div class="hideable" id="basic_stats">
                <h2> Basic attributes </h2>
                {{!Basic attributes}}
                <table class="table">
                    {{#each basic_attribute}}
                    <tr> <td> {{@key}} </td> <td> {{this}} </td> </tr>
                    {{/each}}
                </table>
            </div>

            {{! Listing of variables in model}}
            {{#if variable_table}}
                <div class="d-none hideable" id="model_variables">
                    <h2> Model Variables </h2>
                
                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>{{#each variable_header}}
                                <th> {{this}} </th>
                                {{/each}}
                            </tr>
                        </thead>

                        {{#each variable_table}}
                        <tr>
                            {{#each this}}<td>{{this}}</td>{{/each}}
                        </tr>
                        {{/each}}
                    </table>
                </div>
            {{/if}}

            {{!Each of the XArray objects}}
            {{#each xarrays}}
            <div class="d-none hideable" id="{{@key}}">
                <h2> {{title @key}} </h2>
                {{> xarray }}
            </div>
            {{/each}}

            </div>
            <div class="col-md-2"> </div>
        </div>

      </div>
    </script>

    <script src="../../js/zip/zip.js"></script>
    <script src="../../js/zip/zip-ext.js"></script>
    <script src="../../js/zip/inflate.js"></script>
    <script src="../../js/underscore/underscore-min.js"></script>
    <script src="../../js/npy.js"></script>
    <script src="../../js/npz.js"></script>
    <script src="../../js/handlebars/handlebars-v4.1.0.js"></script>
    <script src="../../js/jstat/jstat.min.js"></script>
    <script src="../../js/arviz.js"></script>
    <script src="../../js/chartjs/chartjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.15.1/dist/tf.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://unpkg.com/d3-dag@0.2.3"></script>

    
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>

    <link rel="stylesheet" type="text/css" href="bootstrap.min.css" />

    <script>
      function showStats(arviz) {
        var sample_attrs = arviz.sample_stats.attrs;        

        var kvs = {
          "Inference Library": sample_attrs.inference_library,
          Version: sample_attrs.inference_library_version,
          Date: sample_attrs.created_at
        };

        function createTable(d, fns) {
          var table = [];
          for (k in d) {
            var v = d[k];
            table.push([k].concat(fns.map(fn => fn(v))));
          }
          return table;
        }
        
        if(sample_attrs.graph)
        {
            var variable_table = createTable(sample_attrs.graph, [
            d => d.type,
            d => d.parents.join(", "),
            d => d.distribution.type,
            d => d.distribution.shape
            ]);
        }

        var source = document.getElementById("entry-template").innerHTML;
        var template = Handlebars.compile(source);

        // print shape of arrays nicely
        Handlebars.registerHelper("shape", function(shape) {
          return "(" + shape.join(", ") + ")";
        });

        // print dtypes in a human readable form
        var dtype_names = {
          "<f8": "float64",
          "<f4": "float32",
          "|b1": "boolean",
          "<i8": "int64",
          "<i2": "int16",
          "<i1": "int8",
          "<i2": "int16",
          "<i4": "int32",
          "<u8": "uint64",
          "<u2": "uint16",
          "<u1": "uint8",
          "<u2": "uint16",
          "<u4": "uint32"
        };

        Handlebars.registerHelper("dtype", function(dtype) {
          return dtype_names[dtype];
        });

        // show title cased, deslugified titles
        Handlebars.registerHelper("title", function(title) {
          return (
            title.charAt(0).toUpperCase() + title.slice(1).replace("_", " ")
          );
        });

        // show shortened version of long arrays
        Handlebars.registerHelper("elide", function(seq) {
          if (seq.length > 6) {
            return (
              seq.slice(0, 3).join(", ") + ", ..., " + seq.slice(-3).join(", ")
            );
          } else return seq.join(", ");
        });

        console.log(arviz);

        // template for an xarray, showing the dimensions, coords and vars
        Handlebars.registerPartial(
          "xarray",
          `            
            {{!--  Dimensions   }}
            {{!--               
                <table class="table">                
                    <thead class="thead-dark">
                        <tr> <th> Dimension </th> <th> Size </th> 
                    </thead>
                    
                    {{#each dims}}                
                    <tr> <td> {{@key}} </td> <td> {{this}} </td> </tr>
                    {{/each}}
                </table>            
            --}}
            
            {{!-- Variables; where the real meat is --}}
            <table class="table table-striped table-hover">
                <thead class="thead-dark">
                <tr> <th> Variable </th> <th> Shape </th> <th> dtype </th> </tr>
                </thead>
                {{#each vars}}                
                <tr> <td> {{@key}} </td> <td> {{shape this.shape}} </td> <td> {{dtype this.dtype}} </td> </tr>
                {{/each}}
            </table>


            {{!-- Coordinates --}}

            {{!--
                <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                        <tr> <th> Coord </th> <th> Values </th> </tr>
                        </thead>
                        {{#each coords}}                
                        <tr> <td> {{@key}} </td> <td> {{elide this}} </td> </tr>
                        {{/each}}
                    </table>
            --}}

          `
        );

        var html = template({
          title: "Inference results",
          basic_attribute: kvs,
          variable_header: ["Name", "Type", "Parents", "Distribution", "Shape"],

          variable_table: variable_table,
          xarrays: {
            sampler_statistics: arviz.sample_stats,
            observed: arviz.observed_data,
            posterior_trace: arviz.posterior,
            posterior_predictive: arviz.posterior_predictive,
            prior: arviz.prior
          }
        });

        $(".template-holder").append(html);
        console.log(html);

        // add navbar functionality
        // hide all sections but the clicked one
        $("ul.nav li").each(function() {          
          $(this).on("click", function(f) {
            // hide everything
            $(".hideable").each(function() {
              $(this).addClass("d-none");
            });
            // unhide the target
            var target = $(this).attr("data-target");
            $("#" + target).removeClass("d-none");
          });
        });
      }
      /////////////////////////////////////////////////////////////////////////////////////
      // Entry point
      load_npz("switchpoint.npz").then(npz_data => showStats(reassemble_arviz(npz_data)));         
    </script>
  </body>
</html>
